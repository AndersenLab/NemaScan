library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(readr)
# library(valr)
library(IRanges)
library(fuzzyjoin)
library(glue)
library(purrr)
# # # arguments

# 1 - a .bim file generated by PLINK
# 2 - number if qtl to simulate 
# 3 - effect size specification (either a range: "0.2-0.3" or "gamma")
# 4 - a bed file that contains genomic ranges to spike in QTL
# setwd("~/Documents/projects/NemaScan_Performance/data")
# args <- c("TO_SIMS.bim", 100, "gamma", "test.bed")
# args <- c("TO_SIMS.bim", 5, "0.2-0.3", "chr125.bed")
args = commandArgs(trailingOnly=TRUE)

variants <- read.table(args[1]) %>%
  dplyr::filter(V1 != "MtDNA") %>%
  dplyr::mutate(end = V4) %>%
  dplyr::select(chrom = V1, start = V4, end, marker = V2)

# if a bed file argument exists subset the variant set to only contain variants within the specified ranges
if(length(args) > 3){
  
  genomic_roi <- read.table(args[4]) %>%
    dplyr::rename(chrom = V1, start = V2, end = V3)
  
  # temp_variants <- valr::bed_intersect(variants, genomic_roi) %>%
  #   dplyr::rename(start = start.x, end = end.x, marker = marker.x)
  
  # couldn't get valr to install in docker, so use fuzzyjoin instead to do the same thing
  temp_variants <- fuzzyjoin::genome_join(variants, genomic_roi, by = c(
          "chrom" = "chrom", 
          "start" = "start", 
          "end" = "end"),
          mode = "left") %>%
      na.omit() %>% 
      dplyr::select(chrom = chrom.x, start = start.x, end = end.x, marker, start.x = start.y, end.x = end.y) %>% 
      dplyr::mutate(.overlap = 0)
  
  # if there are fewer variants in the specified region than the simulate qtl number, replicate some of the region markers
  if(nrow(temp_variants) < as.numeric(args[2])){
    nqtl_variant_diff <- as.numeric(args[2]) - nrow(temp_variants)
    
    variants <- temp_variants %>% dplyr::sample_n(nqtl_variant_diff, 12) %>% dplyr::bind_rows(temp_variants,.)
  } else{
    variants <- temp_variants
  }
  
}


if(args[3] == "gamma"){
  simulate_QTL_effects <- function(n_causal_variants){
    options(scipen = 999)
    
    effects <- rgamma(n = n_causal_variants, shape = 0.4, scale = 1.66)
    
    causal_variants <- sample(variants$marker, 
                              size = n_causal_variants, 
                              replace = F)
    
    direction <- sample(c(-1,1), 
                        size = n_causal_variants, 
                        replace = T)
    
    simulated.QTL.effects <- data.frame(causal_variants, effects*direction)
    
    write.table(simulated.QTL.effects, paste("causal.variants.sim", n_causal_variants, "txt", sep = "."), 
                quote = F, 
                col.names = F, 
                row.names = F)
  }
  
  simulate_QTL_effects(args[2])
} else {
  low_end <- strsplit(args[3], split = "-")[[1]][1]
  high_end <- strsplit(args[3], split = "-")[[1]][2]
  
  simulate_QTL_effects_normal <- function(n_causal_variants, l_e, h_e){
    options(scipen = 999)
    
    effects <- runif(n_causal_variants, min = as.numeric(l_e), max = as.numeric(h_e))
    
    causal_variants <- sample(variants$marker, 
                              size = n_causal_variants, 
                              replace = F)
    
    direction <- sample(c(-1,1), 
                        size = n_causal_variants, 
                        replace = T)
    
    simulated.QTL.effects <- data.frame(causal_variants, effects*direction)
    
    write.table(simulated.QTL.effects, paste("causal.variants.sim", n_causal_variants, "txt", sep = "."), 
                quote = F, 
                col.names = F, 
                row.names = F)
  }
  
  simulate_QTL_effects_normal(args[2], l_e = low_end, h_e = high_end)
}
